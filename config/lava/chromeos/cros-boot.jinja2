{% extends 'base/kernel-ci-base.jinja2' %}
{% block main %}
{%- if extra_kernel_args %}
{% do context.update({"extra_kernel_args": extra_kernel_args}) %}
{% endif %}
{{ super () }}
{%- if device_id %}
tags: ['{{ device_id }}']
{%- endif %}
{% endblock %}

{% block actions %}
{{ super () }}
actions:

{% if not cros_flash_kernel %}
{{ kci_raise("CrOS parameter cros_flash_kernel missing. Invalid target?") }}
{%- endif %}

# Debian NFS to install kernel modules

- deploy:
    namespace: modules
    timeout:
      minutes: 5
    to: tftp
    kernel:
      url: {{ cros_flash_kernel.base_url }}{{ cros_flash_kernel.image }}
    modules:
      url: {{ cros_flash_kernel.base_url }}{{ cros_flash_kernel.modules }}
      compression: {{ cros_flash_kernel.modules_compression }}
    nfsrootfs:
      url: {{ cros_flash_nfs.base_url }}{{ cros_flash_nfs.rootfs }}
      compression: {{ cros_flash_nfs.rootfs_compression }}
    ramdisk:
      url: {{ cros_flash_nfs.base_url }}{{ cros_flash_nfs.initrd }}
      compression: {{ cros_flash_nfs.initrd_compression }}
{%- if cros_flash_kernel.dtb %}
    dtb:
      url: {{ cros_flash_kernel.base_url }}{{ cros_flash_kernel.dtb }}
{%- endif %}
    os: oe

- boot:
    namespace: modules
    timeout:
      minutes: 10
    timeouts:
      bootloader-commands:
        minutes: 3
      auto-login-action:
        minutes: 2
    failure_retry: 3
    method: depthcharge
    commands: nfs
    prompts:
      - '/ #'

- test:
    namespace: modules
    timeout:
      minutes: 5
    definitions:
    - repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: modules
          description: modules
          os:
            - oe
          scope:
            - functional
          environment:
            - lava-test-shell
        run:
          steps:
            - >-
              /opt/chromeos/install-modules
{%- if fixed_kernel is not defined %}
              {{ modules_url }}
{%- else %}
              {{ reference_kernel.modules }}
{%- endif %}
              || lava-test-raise "modules-install"
      from: inline
      name: modules
      path: inline/modules.yaml

# Chrome OS

- deploy:
    namespace: chromeos
    timeout:
      minutes: 10
    to: tftp
    kernel:
{%- if fixed_kernel is not defined %}
      url: {{ kernel_url }}
{%- else %}
      # Fixed reference kernel
      url: {{ reference_kernel.image }}
{%- endif %}

{%- if dtb_url %}
# If dtb_url present, this arch need dtb
{%- if fixed_kernel is not defined %}
    dtb:
      url: {{ dtb_url }}
{%- else %}
    # Fixed reference dtb
    dtb:
      url: {{ reference_kernel.dtb }}
{%- endif %}
{%- endif %}
    os: oe

- boot:
    namespace: chromeos
    timeout:
      minutes: 10
    timeouts:
      bootloader-commands:
        minutes: 3
      auto-login-action:
        minutes: 2
    failure_retry: 3
    method: depthcharge
    commands: emmc
    extra_kernel_args: cros_secure cros_debug root=PARTUUID=566f7961-6765-7220-746f-20756e697665 rootwait ro
    prompts:
      - 'localhost(.*)~(.*)#'
    failure_message: 'chromeos-boot-alert: self_repair'
    auto_login:
      login_prompt: "login:"
      username: "root"
      password_prompt: "Password:"
      password: "test0000"
{% endblock %}
