{% extends base_template|default('chromeos/cros-boot.jinja2') %}
{% block actions %}
{{ super() }}
- test:
    namespace: chromeos
    timeout:
      minutes: 5
    docker:
      image: {{ docker_image }}
      wait:
        device: true
    results:
      location: /home/cros/lava
    definitions:
    - repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: cros-baseline
        run:
          steps:
            - cd /home/cros
            - while ! ping -c 1 -w 1 $(lava-target-ip); do sleep 1; done
            - >-
              KERNELCI_LAVA=y
              cmdwrapper="ssh -i /home/cros/.ssh/id_rsa -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$(lava-target-ip)"
              /bin/sh dmesg.sh
            - >-
              ./ssh_retry.sh
              -o StrictHostKeyChecking=no
              -o UserKnownHostsFile=/dev/null
              -i /home/cros/.ssh/id_rsa
              root@$(lava-target-ip)
              sync
            # Wait for DUT to shut down, or keep going if unreachable (e.g. crashed)
            - >-
              ./ssh_retry.sh
              -o StrictHostKeyChecking=no
              -o UserKnownHostsFile=/dev/null
              -i /home/cros/.ssh/id_rsa
              root@$(lava-target-ip)
              poweroff && sleep 30 || true
      from: inline
      name: dmesg
      path: inline/cros-baseline.yaml
{% endblock %}
