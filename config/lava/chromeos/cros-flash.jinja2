{% extends 'base/kernel-ci-base.jinja2' %}
{% block main %}
{{ super () }}
context:
  extra_kernel_args: console_msg_format=syslog cros_secure cros_debug
{% if device_id %}
tags: ['{{ device_id }}']
{%- endif %}
{%- endblock %}

{% block actions %}
{{ super () }}

actions:
- deploy:
    kernel:
      url: {{ flashing_kernel }}
    modules:
      url: {{ flashing_modules }}
      compression: xz
    nfsrootfs:
      url: {{ flashing_rootfs }}
      compression: xz
    ramdisk:
      url: {{ flashing_ramdisk }}
      compression: gz
    os: oe
    timeout:
      minutes: 60
    to: tftp


- boot:
    timeout:
      minutes: 60
    method: depthcharge
    commands: nfs
    prompts:
      - '/ #'

- test:
    timeout:
      minutes: 60
    docker:
      image: {{ docker_image }}
      wait:
        device: true
    definitions:
    - repository:
        metadata:
          format: Lava-Test Test Definition 1.0
          name: cros-flash
        run:
          steps:
            - ping -c 1 172.17.0.1
            - lava-test-case wget --shell "wget --no-check-certificate -O chromiumos_test_image.bin.gz {{ chromeos_image }}"
            - lava-test-case unpack --shell "gzip -d chromiumos_test_image.bin.gz || mv chromiumos_test_image.bin.gz chromiumos_test_image.bin"
            - lava-test-case scp --shell "scp -C -i /keys/id_rsa_chromeos_flash -o ConnectTimeout=3 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null chromiumos_test_image.bin root@$(lava-target-ip):/root"
            - ssh -i /keys/id_rsa_chromeos_flash -o ConnectTimeout=3 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null root@$(lava-target-ip) "IMAGE_NAME=chromiumos_test_image.bin FLASH_DEVICE={{ flashing_device }} /bin/bash /opt/chromeos/flash"
      from: inline
      name: cros-flash
      path: inline/cros-flash.yaml

{% endblock %}
